name: 自动测试所有小脚本喵~ 🐾

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'scripts/**.sh'

  workflow_dispatch:

jobs:
  discover-scripts:
    name: 发现所有要运行的小脚本喵 🧐
    runs-on: ubuntu-latest
    outputs:
      script_matrix: ${{ steps.set-matrix.outputs.scripts }}

    steps:
      - name: 先把主人的代码拿过来喵～
        uses: actions/checkout@v4

      - name: 看看 scripts 文件夹里都有谁喵...
        id: set-matrix
        run: |
          scripts=$(ls -1 scripts/*.sh 2>/dev/null | jq -R . | jq -s -c .)
          echo "发现的脚本有: $scripts 喵"
          echo "scripts=$scripts" >> $GITHUB_OUTPUT

  run-scripts:
    needs: discover-scripts
    if: needs.discover-scripts.outputs.script_matrix != '[]'
    name: 正在努力执行 -> ${{ matrix.script_name }} 喵! 🚀
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        script_name: ${{ fromJson(needs.discover-scripts.outputs.script_matrix) }}

    runs-on: ubuntu-latest

    steps:
      - name: 再次把主人的代码拿过来喵～
        uses: actions/checkout@v4

      - name: 赋予魔法力量并以 root 身份开始执行喵！✨
        run: |
          echo "正在给 ${{ matrix.script_name }} 注入执行的魔法力量 (chmod +x) 喵..."
          chmod +x ${{ matrix.script_name }}
          
          echo "开始使用 root 的魔法力量执行 ${{ matrix.script_name }} 喵！加油喵！"
          # 脚本需要 root 权限，所以我们在它前面加上 sudo 喵
          sudo ./${{ matrix.script_name }}