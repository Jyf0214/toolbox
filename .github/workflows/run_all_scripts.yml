name: è‡ªåŠ¨æµ‹è¯•æ‰€æœ‰å°è„šæœ¬å–µ~ ğŸ¾

on:
  # å½“ä¸»äººæ¨é€åˆ° main åˆ†æ”¯æ—¶ï¼Œäººå®¶å°±ä¼šè‡ªåŠ¨å¼€å§‹å·¥ä½œå–µï¼
  push:
    branches: [ "main", "master" ]
    paths:
      - 'scripts/**.sh' # åªæœ‰ scripts ç›®å½•é‡Œçš„è„šæœ¬å˜åŒ–äº†æ‰è§¦å‘å–µ

  # ä¹Ÿç»™ä¸»äººä¸€ä¸ªæ‰‹åŠ¨è¿è¡Œçš„æŒ‰é’®å–µï¼Œæƒ³ä»€ä¹ˆæ—¶å€™è·‘å°±ä»€ä¹ˆæ—¶å€™è·‘~
  workflow_dispatch:

jobs:
  # ç¬¬ä¸€ä¸ªå·¥ä½œï¼šä¾¦å¯Ÿå…µå‡ºåŠ¨ï¼å»å‘ç°æ‰€æœ‰éœ€è¦è¿è¡Œçš„è„šæœ¬å–µ
  discover-scripts:
    name: å‘ç°æ‰€æœ‰è¦è¿è¡Œçš„å°è„šæœ¬å–µ ğŸ§
    runs-on: ubuntu-latest
    outputs:
      # æŠŠæ‰¾åˆ°çš„è„šæœ¬åˆ—è¡¨ï¼ˆJSONæ ¼å¼ï¼‰æŠ¥å‘Šç»™ä¸‹ä¸€ä¸ªå·¥ä½œå–µ
      script_matrix: ${{ steps.set-matrix.outputs.scripts }}

    steps:
      - name: å…ˆæŠŠä¸»äººçš„ä»£ç æ‹¿è¿‡æ¥å–µï½
        uses: actions/checkout@v4
        # éœ€è¦è·å–å†å²è®°å½•æ‰èƒ½æ¯”è¾ƒæ–‡ä»¶çš„å˜åŒ–å–µ
        with:
          fetch-depth: 2

      - name: å¯»æ‰¾å‘ç”Ÿå˜åŒ–çš„è„šæœ¬æ–‡ä»¶å–µ (ä»…åœ¨æ¨é€æ—¶)
        # è¿™ä¸ªç¥å¥‡çš„å·¥å…·å¯ä»¥å¸®æˆ‘ä»¬æ‰¾åˆ°è¢«ä¿®æ”¹è¿‡çš„æ–‡ä»¶å–µ
        id: get_changed_scripts
        if: github.event_name == 'push' # åªåœ¨ push äº‹ä»¶æ—¶è¿è¡Œè¿™ä¸€æ­¥
        uses: tj-actions/changed-files@v44
        with:
          files: scripts/**.sh

      - name: ç¡®å®šæœ€ç»ˆè¦è¿è¡Œçš„è„šæœ¬åˆ—è¡¨å–µ...
        id: set-matrix
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # å¦‚æœæ˜¯æ¨é€äº‹ä»¶ï¼Œå°±åªè¿è¡Œå˜åŒ–çš„è„šæœ¬å–µ
            echo "æ˜¯æ¨é€äº‹ä»¶ï¼Œæ­£åœ¨å¯»æ‰¾å˜åŒ–çš„è„šæœ¬å–µ..."
            scripts_list="${{ steps.get_changed_scripts.outputs.all_changed_files }}"
            if [[ -z "$scripts_list" ]]; then
              echo "æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•è„šæœ¬æ–‡ä»¶å˜åŒ–å–µ~ æœ¬æ¬¡ä¸è¿è¡Œä»»ä½•è„šæœ¬ã€‚"
              scripts="[]"
            else
              # æŠŠç©ºæ ¼åˆ†éš”çš„æ–‡ä»¶åˆ—è¡¨å˜æˆç´§å‡‘çš„ JSON æ•°ç»„
              echo "æ‰¾åˆ°è¿™äº›å˜åŒ–çš„è„šæœ¬: $scripts_list"
              scripts=$(echo "$scripts_list" | tr ' ' '\n' | jq -R . | jq -s -c .)
            fi
          else
            # å¦‚æœæ˜¯æ‰‹åŠ¨è¿è¡Œï¼Œå°±è¿è¡Œæ‰€æœ‰çš„è„šæœ¬å–µ
            echo "æ˜¯æ‰‹åŠ¨è¿è¡Œï¼Œæ­£åœ¨å¯»æ‰¾æ‰€æœ‰è„šæœ¬å–µ..."
            scripts=$(ls -1 scripts/*.sh 2>/dev/null | jq -R . | jq -s -c .)
          fi
          echo "æœ€ç»ˆç¡®å®šçš„è„šæœ¬åˆ—è¡¨æ˜¯: $scripts å–µ"
          echo "scripts=$scripts" >> $GITHUB_OUTPUT

  # ç¬¬äºŒä¸ªå·¥ä½œï¼šLinux æ‰§è¡Œå®˜å‡ºåŠ¨ï¼
  run-scripts-linux:
    needs: discover-scripts
    if: needs.discover-scripts.outputs.script_matrix != '[]'
    name: åœ¨å°ä¼é¹…ä¸Šæ‰§è¡Œ -> ${{ matrix.script_name }} å–µ! ğŸ§
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        script_name: ${{ fromJson(needs.discover-scripts.outputs.script_matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: å†æ¬¡æŠŠä¸»äººçš„ä»£ç æ‹¿è¿‡æ¥å–µï½
        uses: actions/checkout@v4
      - name: èµ‹äºˆé­”æ³•åŠ›é‡å¹¶ä»¥ root èº«ä»½å¼€å§‹æ‰§è¡Œå–µï¼âœ¨
        run: |
          chmod +x ${{ matrix.script_name }}
          echo "å¼€å§‹ä½¿ç”¨ root çš„é­”æ³•åŠ›é‡æ‰§è¡Œ ${{ matrix.script_name }} å–µï¼"
          sudo ./${{ matrix.script_name }}

  # ç¬¬ä¸‰ä¸ªå·¥ä½œï¼šWindows æ‰§è¡Œå®˜ä¹Ÿå‡ºåŠ¨äº†ï¼
  run-scripts-windows:
    needs: discover-scripts
    if: needs.discover-scripts.outputs.script_matrix != '[]'
    name: åœ¨çª—æˆ·ä¸Šæ‰§è¡Œ -> ${{ matrix.script_name }} å–µ! ğŸªŸ
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        script_name: ${{ fromJson(needs.discover-scripts.outputs.script_matrix) }}
    runs-on: windows-latest
    steps:
      - name: å†æ¬¡æŠŠä¸»äººçš„ä»£ç æ‹¿è¿‡æ¥å–µï½
        uses: actions/checkout@v4
      - name: èµ‹äºˆé­”æ³•åŠ›é‡å¹¶å¼€å§‹æ‰§è¡Œå–µï¼âœ¨
        # åœ¨ Windows ä¸Šï¼Œæˆ‘ä»¬ç”¨ Bash æ¥è¿è¡Œè„šæœ¬å–µ
        shell: bash
        run: |
          chmod +x ${{ matrix.script_name }}
          echo "å¼€å§‹æ‰§è¡Œ ${{ matrix.script_name }} å–µï¼"
          # Windowsä¸Šæ²¡æœ‰ sudoï¼Œæ‰€ä»¥ç›´æ¥è¿è¡Œå–µ
          ./${{ matrix.script_name }}