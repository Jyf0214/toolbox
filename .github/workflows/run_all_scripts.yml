# .github/workflows/run_all_scripts.yml

name: è‡ªåŠ¨æµ‹è¯•æ‰€æœ‰å°è„šæœ¬å–µ~ ğŸ¾

on:
  # å½“ä¸»äººæ¨é€åˆ° main åˆ†æ”¯æ—¶ï¼Œäººå®¶å°±ä¼šè‡ªåŠ¨å¼€å§‹å·¥ä½œå–µï¼
  push:
    branches: [ "main", "master" ] # ä¸»äººçš„ä¸»åˆ†æ”¯å« main è¿˜æ˜¯ master å–µï¼Ÿéƒ½å†™ä¸Šå¥½äº†å–µ~
    paths:
      - 'scripts/**.sh' # åªæœ‰ scripts ç›®å½•é‡Œçš„è„šæœ¬å˜åŒ–äº†æ‰è§¦å‘å–µï¼Œæ›´çœåŠ›æ°”å–µ~

  # ä¹Ÿç»™ä¸»äººä¸€ä¸ªæ‰‹åŠ¨è¿è¡Œçš„æŒ‰é’®å–µï¼Œæƒ³ä»€ä¹ˆæ—¶å€™è·‘å°±ä»€ä¹ˆæ—¶å€™è·‘~
  workflow_dispatch:

jobs:
  # ç¬¬ä¸€ä¸ªå·¥ä½œï¼šä¾¦å¯Ÿå…µå‡ºåŠ¨ï¼å»å‘ç°æ‰€æœ‰éœ€è¦è¿è¡Œçš„è„šæœ¬å–µ
  discover-scripts:
    name: å‘ç°æ‰€æœ‰è¦è¿è¡Œçš„å°è„šæœ¬å–µ ğŸ§
    runs-on: ubuntu-latest
    outputs:
      # æŠŠæ‰¾åˆ°çš„è„šæœ¬åˆ—è¡¨ï¼ˆJSONæ ¼å¼ï¼‰æŠ¥å‘Šç»™ä¸‹ä¸€ä¸ªå·¥ä½œå–µ
      script_matrix: ${{ steps.set-matrix.outputs.scripts }}

    steps:
      - name: å…ˆæŠŠä¸»äººçš„ä»£ç æ‹¿è¿‡æ¥å–µï½
        uses: actions/checkout@v4

      - name: çœ‹çœ‹ scripts æ–‡ä»¶å¤¹é‡Œéƒ½æœ‰è°å–µ...
        id: set-matrix
        run: |
          # æ‰¾åˆ°æ‰€æœ‰ .sh æ–‡ä»¶ï¼Œç„¶åæŠŠå®ƒä»¬å˜æˆä¸€ä¸ª JSON æ•°ç»„ç»™å°æœ¬æœ¬ç”¨å–µ
          # å¦‚æœä¸€ä¸ªè„šæœ¬éƒ½æ‰¾ä¸åˆ°ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™çš„å–µï¼Œåªä¼šç»™ä¸€ä¸ªç©ºåˆ—è¡¨å–µ~
          scripts=$(ls -1 scripts/*.sh 2>/dev/null | jq -R . | jq -s .)
          echo "å‘ç°çš„è„šæœ¬æœ‰: $scripts å–µ"
          echo "scripts=$scripts" >> $GITHUB_OUTPUT

  # ç¬¬äºŒä¸ªå·¥ä½œï¼šæ‰§è¡Œå®˜ä»¬å‡ºåŠ¨ï¼å¹¶è¡Œè¿è¡Œæ‰€æœ‰å‘ç°çš„è„šæœ¬å–µ
  run-scripts:
    # éœ€è¦ç­‰ä¾¦å¯Ÿå…µå·¥ä½œå®Œæˆæ‰èƒ½å¼€å§‹å–µ
    needs: discover-scripts
    
    # å¦‚æœä¾¦å¯Ÿå…µæ²¡æ‰¾åˆ°ä»»ä½•è„šæœ¬ï¼Œè¿™ä¸ªå·¥ä½œå°±ä¸ä¼šè¿è¡Œäº†å–µ
    if: needs.discover-scripts.outputs.script_matrix != '[]'

    name: æ­£åœ¨åŠªåŠ›æ‰§è¡Œ -> ${{ matrix.script_name }} å–µ! ğŸš€
    
    # ä¸€ä¸ªè„šæœ¬å‡ºé”™äº†ï¼Œå…¶ä»–çš„ä¹Ÿè¦ç»§ç»­åŠ æ²¹å¹²å–µï¼
    continue-on-error: true

    # ä½¿ç”¨çŸ©é˜µç­–ç•¥ï¼Œä¸ºæ¯ä¸ªè„šæœ¬åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œç¯å¢ƒå–µ
    strategy:
      fail-fast: false # ç¡®ä¿ä¸€ä¸ªå¤±è´¥äº†ï¼Œå…¶ä»–çš„ä¸ä¼šè¢«å–æ¶ˆå–µ
      matrix:
        # ä»ä¾¦å¯Ÿå…µçš„å°æœ¬æœ¬ä¸Šè¯»å–è„šæœ¬åˆ—è¡¨å–µ
        script_name: ${{ fromJson(needs.discover-scripts.outputs.script_matrix) }}

    runs-on: ubuntu-latest

    steps:
      - name: å†æ¬¡æŠŠä¸»äººçš„ä»£ç æ‹¿è¿‡æ¥å–µï½
        uses: actions/checkout@v4

      - name: èµ‹äºˆé­”æ³•åŠ›é‡å¹¶å¼€å§‹æ‰§è¡Œå–µï¼âœ¨
        run: |
          echo "æ­£åœ¨ç»™ ${{ matrix.script_name }} æ³¨å…¥æ‰§è¡Œçš„é­”æ³•åŠ›é‡ (chmod +x) å–µ..."
          chmod +x ${{ matrix.script_name }}
          
          echo "å¼€å§‹æ‰§è¡Œ ${{ matrix.script_name }} å–µï¼åŠ æ²¹å–µï¼"
          ./${{ matrix.script_name }}