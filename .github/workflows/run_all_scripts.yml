name: è‡ªåŠ¨æµ‹è¯•æ‰€æœ‰å°è„šæœ¬å–µ~ ğŸ¾

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'scripts/**.sh'

  workflow_dispatch:

jobs:
  discover-scripts:
    name: å‘ç°æ‰€æœ‰è¦è¿è¡Œçš„å°è„šæœ¬å–µ ğŸ§
    runs-on: ubuntu-latest
    outputs:
      script_matrix: ${{ steps.set-matrix.outputs.scripts }}

    steps:
      - name: å…ˆæŠŠä¸»äººçš„ä»£ç æ‹¿è¿‡æ¥å–µï½
        uses: actions/checkout@v4

      - name: çœ‹çœ‹ scripts æ–‡ä»¶å¤¹é‡Œéƒ½æœ‰è°å–µ...
        id: set-matrix
        run: |
          scripts=$(ls -1 scripts/*.sh 2>/dev/null | jq -R . | jq -s -c .)
          echo "å‘ç°çš„è„šæœ¬æœ‰: $scripts å–µ"
          echo "scripts=$scripts" >> $GITHUB_OUTPUT

  run-scripts:
    needs: discover-scripts
    if: needs.discover-scripts.outputs.script_matrix != '[]'
    name: æ­£åœ¨åŠªåŠ›æ‰§è¡Œ -> ${{ matrix.script_name }} å–µ! ğŸš€
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        script_name: ${{ fromJson(needs.discover-scripts.outputs.script_matrix) }}

    runs-on: ubuntu-latest

    steps:
      - name: å†æ¬¡æŠŠä¸»äººçš„ä»£ç æ‹¿è¿‡æ¥å–µï½
        uses: actions/checkout@v4

      - name: èµ‹äºˆé­”æ³•åŠ›é‡å¹¶ä»¥ root èº«ä»½å¼€å§‹æ‰§è¡Œå–µï¼âœ¨
        run: |
          echo "æ­£åœ¨ç»™ ${{ matrix.script_name }} æ³¨å…¥æ‰§è¡Œçš„é­”æ³•åŠ›é‡ (chmod +x) å–µ..."
          chmod +x ${{ matrix.script_name }}
          
          echo "å¼€å§‹ä½¿ç”¨ root çš„é­”æ³•åŠ›é‡æ‰§è¡Œ ${{ matrix.script_name }} å–µï¼åŠ æ²¹å–µï¼"
          # è„šæœ¬éœ€è¦ root æƒé™ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®ƒå‰é¢åŠ ä¸Š sudo å–µ
          sudo ./${{ matrix.script_name }}