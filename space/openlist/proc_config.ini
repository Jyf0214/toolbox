[supervisord]
nodaemon=true
logfile=/var/log/service_manager/manager.log
pidfile=/var/log/service_manager/manager.pid ; <-- 修正 PID 路径
user=appuser
loglevel=critical

[program:log_viewer] ; <-- 新增：统一的日志查看器
command=tail -f /var/log/service_manager/*.log
user=appuser
autostart=true
autorestart=true
priority=500 ; <-- 最低优先级
stdout_logfile=/dev/stdout ; <-- 唯一写入主日志的进程
redirect_stderr=true

[program:initial_restore]
; --- 关键改动：修正 litestream 命令，并增加 -if-replica-exists ---
command=bash -c "echo 'Attempting initial restore...' && litestream restore -if-replica-exists -config /etc/litestream.yml ${DATA_DIR}/data.db && rclone copyto 'b2:${B2_BUCKET_NAME}/${B2_PATH_PREFIX}/config.json' '${DATA_DIR}/config.json' --ignore-errors && echo 'Restore finished.'"
user=appuser
autostart=true
autorestart=false
startsecs=0
priority=100 ; <-- 最高优先级
stdout_logfile=/var/log/service_manager/restore.log
redirect_stderr=true

[program:main_app]
command=openlist server
directory=/home/appuser
user=appuser
autostart=true
autorestart=true
startsecs=5
priority=200
stdout_logfile=/var/log/service_manager/main_app.log
redirect_stderr=true

[program:db_replication]
command=litestream replicate -config /etc/litestream.yml
user=appuser
autostart=true
autorestart=true
startsecs=10
priority=300
stdout_logfile=/var/log/service_manager/db_replication.log
redirect_stderr=true

[program:config_sync_up]
command=bash -c 'while true; do sleep 300; rclone copyto "${DATA_DIR}/config.json" "b2:${B2_BUCKET_NAME}/${B2_PATH_PREFIX}/config.json"; done'
user=appuser
autostart=true
autorestart=true
startsecs=10
priority=300
stdout_logfile=/var/log/service_manager/config_sync.log
redirect_stderr=true

[program:static_server]
command=python3 -m http.server 7860 --directory /app/static
directory=/app/static
user=appuser
autostart=true
autorestart=true
priority=300
stdout_logfile=/dev/null
redirect_stderr=true

[program:tunnel_client]
command=/opt/tunnel/frpc -u %(ENV_FRPC_SECRET_KEY)s -p 201696
directory=/opt/tunnel
user=appuser
autostart=true
autorestart=true
priority=300
stdout_logfile=/dev/null
redirect_stderr=true