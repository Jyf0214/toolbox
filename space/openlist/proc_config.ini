[supervisord]
nodaemon=true
logfile=/var/log/service_manager/manager.log
pidfile=/var/log/service_manager/manager.pid
user=appuser
loglevel=critical

[program:initial_restore]
command=bash -c "rclone --config /home/appuser/.config/rclone/rclone.conf copyto 'b2:%(ENV_B2_BUCKET_NAME)s/%(ENV_B2_PATH_PREFIX)s/db_backup.db' '/home/appuser/backup/db_backup.db' --ignore-errors && ([ -f /home/appuser/backup/db_backup.db ] && cp /home/appuser/backup/db_backup.db /home/appuser/data/data.db || echo 'No remote DB backup found, skipping.') && rclone --config /home/appuser/.config/rclone/rclone.conf copyto 'b2:%(ENV_B2_BUCKET_NAME)s/%(ENV_B2_PATH_PREFIX)s/config.json' '/home/appuser/data/config.json' --ignore-errors && rclone --config /home/appuser/.config/rclone/rclone.conf copyto 'b2:%(ENV_B2_BUCKET_NAME)s/%(ENV_B2_PATH_PREFIX)s/config.yaml' '/home/appuser/data/config.yaml' --ignore-errors"
user=appuser
autostart=true
autorestart=false
startsecs=0
priority=100
stdout_logfile=/dev/null
redirect_stderr=true

[program:main_app]
command=openlist server
directory=/home/appuser
user=appuser
autostart=true
autorestart=true
startsecs=5
priority=200
stdout_logfile=/dev/null
redirect_stderr=true

[program:backup_sync]
command=bash -c 'while true; do sqlite3 /home/appuser/data/data.db ".backup \"/home/appuser/backup/db_backup.db\""; rclone --config /home/appuser/.config/rclone/rclone.conf copyto "/home/appuser/backup/db_backup.db" "b2:%(ENV_B2_BUCKET_NAME)s/%(ENV_B2_PATH_PREFIX)s/db_backup.db" || echo "Backup failed"; rclone --config /home/appuser/.config/rclone/rclone.conf copyto "/home/appuser/data/config.json" "b2:%(ENV_B2_BUCKET_NAME)s/%(ENV_B2_PATH_PREFIX)s/config.json" || echo "Config.json backup failed"; rclone --config /home/appuser/.config/rclone/rclone.conf copyto "/home/appuser/data/config.yaml" "b2:%(ENV_B2_BUCKET_NAME)s/%(ENV_B2_PATH_PREFIX)s/config.yaml" || echo "Config.yaml backup failed"; sleep 300; done'
user=appuser
autostart=true
autorestart=true
startsecs=10
priority=300
stdout_logfile=/var/log/service_manager/backup_sync.log
redirect_stderr=true

[program:static_server]
command=python3 -m http.server 7860 --directory /app/static
directory=/app/static
user=appuser
autostart=true
autorestart=true
priority=300
stdout_logfile=/dev/null
redirect_stderr=true

[program:tunnel_client]
command=/opt/tunnel/frpc -u %(ENV_FRPC_SECRET_KEY)s -p 201696
directory=/opt/tunnel
user=appuser
autostart=true
autorestart=true
priority=300
stdout_logfile=/dev/null
redirect_stderr=true